#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

int max(int x, int y)
{
    if (x > y) return x;
    return y;
}

// TLE, O(n^3) is too slow
int longestValidParentheses1(char* s) {
    int ans = 0;
    int len = strlen(s);
    bool valid[len+1][len+1];
    memset(valid, 0, sizeof valid);
    
    for (int i=0; i<len-1; ++i)
    {
        if (s[i]=='(' && s[i+1]==')')
        {
            valid[i][i+1] = true;
            ans = max(ans, 2);
        }
    }


    for (int l=3; l<=len; ++l)
    {
        for (int i=0; i+l-1 < len; ++i)
        {
            int j = i+l-1;
            valid[i][j] = false;
            if (s[i] == '(' && s[j] == ')' && valid[i+1][j-1])
            {
                valid[i][j] = true;
                ans = max(ans, l);
                break;
            }
            else
            {
                for (int k=i+2; k<=j-1; ++k)
                    if (valid[i][k-1] && valid[k][j])
                    {
                        valid[i][j] = true;
                        ans = max(ans, l);
                        break;
                    }

            }

        }

    }
    return ans; 
}

// DP, O(n)

int longestValidParentheses(char* s) {
    int ans = 0;
    /*
     * 
     *         if s[i] == '(' then 0
     * f[i]  = if s[i] == ')' and s[i-f[i-1]-1] == '(' then f[i-1] + 2 + f[i-f[i-1]-1]
     *         else 0
     */
    int len = strlen(s);
    int f[len+1];
    memset(f, 0, sizeof f);

    for (int i=0; i< len; ++i)
    {
        if (s[i] == '(')
            f[i] = 0;
        else
        {
            int lft = i-f[i-1]-1;
            if (lft >= 0 && s[lft] == '(')
                f[i] = f[i-1] + 2 + (lft == 0? 0 :f[lft-1]);
            else
                f[i] = 0;
        }
        printf("i f[i]: %d %d\n", i, f[i]);
        ans = max(ans, f[i]);
    }
    return ans;
}

int main()
{

    char* inp = "()()()";
    printf("%s %d\n", inp, longestValidParentheses(inp));

    inp = "(()())(()";
    printf("%s %d\n", inp, longestValidParentheses(inp));

 //   inp = "((())())(()))(()()(()(()))(()((((()))))))((()())()))()()(()(((((()()()())))()())(()()))((((((())))((()))()()))))(()))())))()))()())((()()))))(()(((((())))))()((()(()(())((((())(())((()()(()())))())(()(())()()))())(()()()))()(((()())(((()()())))(((()()()))(()()))()))()))))))())()()((()(())(()))()((()()()((())))()(((()())(()))())())))(((()))))())))()(())))()())))())()((()))((()))()))(((())((()()()(()((()((())))((()()))())(()()(()))))())((())))(()))()))))))()(()))())(()())))))(()))((())(()((())(((((()()()(()()())))(()())()((()(()()))(()(())((()((()))))))))(()(())()())()(()(()(()))()()()(()()())))(())(()((((()()))())))(())((()(())())))))())()()))(((())))())((()(()))(()()))((())(())))))(()(()((()((()()))))))(()()()(()()()(()(())()))()))(((()(())()())(()))())))(((()))())(()((()))(()((()()()(())()(()())()(())(()(()((((())()))(((()()(((()())(()()()(())()())())(()(()()((()))))()(()))))(((())))()()))(()))((()))))()()))))((((()(())()()()((()))((()))())())(()((()()())))))))()))(((()))))))(()())))(((()))((()))())))(((()(((())))())(()))))(((()(((((((((((((())(((()))((((())())()))())((((())(((())))())(((()))))()())()(())())(()))))()))()()()))(((((())()()((()))())(()))()()(()()))(())(()()))()))))(((())))))((()()(()()()()((())((((())())))))((((((()((()((())())(()((()))(()())())())(()(())(())(()((())((())))(())())))(()()())((((()))))((()(())(()(()())))))))))((()())()()))((()(((()((()))(((((()()()()()(()(()((()(()))(()(()((()()))))()(()()((((((()((()())()))((())()()(((((()(()))))()()((()())((()())()(())((()))()()(()))";
  //  printf("%s %d\n", inp, longestValidParentheses(inp));
    return 0;
}
